<!DOCTYPE html><html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/header :: header" th:with="title='Thanh toán - BookHaven'"></head>
<body>
<!-- Navigation -->
<div th:replace="layout/header :: navigation"></div>

<!-- Flash Messages -->
<div th:replace="layout/header :: messages"></div>

<!-- Breadcrumb -->
<section class="bg-light py-3">
    <div class="container">
        <h2>Thanh toán</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/cart">Giỏ hàng</a></li>
                <li class="breadcrumb-item active">Thanh toán</li>
            </ol>
        </nav>
    </div>
</section>

<!-- Checkout Content -->
<section class="py-5">
    <div class="container">
        <form th:action="@{/checkout/place-order}" method="post">
            <div class="row">
                <!-- Shipping Information -->
                <div class="col-lg-7 mb-4">
                    <!-- Delivery Info -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-truck"></i> Thông tin giao hàng
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="receiverName" class="form-label">
                                        Người nhận <span class="text-danger">*</span>
                                    </label>
                                    <input type="text"
                                           class="form-control"
                                           id="receiverName"
                                           name="receiverName"
                                           th:value="${user.fullName}"
                                           required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="shippingPhone" class="form-label">
                                        Số điện thoại <span class="text-danger">*</span>
                                    </label>
                                    <input type="tel"
                                           class="form-control"
                                           id="shippingPhone"
                                           name="shippingPhone"
                                           th:value="${user.phone}"
                                           pattern="[0-9]{10,11}"
                                           required>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email"
                                           class="form-control"
                                           th:value="${user.email}"
                                           disabled>
                                </div>

                                <div class="col-md-12 mb-3">
                                    <label for="shippingAddress" class="form-label">
                                        Địa chỉ giao hàng <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control"
                                              id="shippingAddress"
                                              name="shippingAddress"
                                              rows="3"
                                              placeholder="Số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành phố"
                                              required th:text="${user.address}"></textarea>
                                </div>

                                <div class="col-md-12">
                                    <label for="note" class="form-label">Ghi chú (tùy chọn)</label>
                                    <textarea class="form-control"
                                              id="note"
                                              name="note"
                                              rows="2"
                                              placeholder="Ví dụ: Giao hàng giờ hành chính, gọi trước khi giao..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-credit-card"></i> Phương thức thanh toán
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input"
                                       type="radio"
                                       name="paymentMethod"
                                       id="cod"
                                       value="COD"
                                       checked>
                                <label class="form-check-label" for="cod">
                                    <strong>Thanh toán khi nhận hàng (COD)</strong>
                                    <p class="text-muted small mb-0">Thanh toán bằng tiền mặt khi nhận hàng</p>
                                </label>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input"
                                       type="radio"
                                       name="paymentMethod"
                                       id="bank"
                                       value="BANK_TRANSFER">
                                <label class="form-check-label" for="bank">
                                    <strong>Chuyển khoản ngân hàng</strong>
                                    <p class="text-muted small mb-0">Chuyển khoản qua Internet Banking</p>
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="paymentMethod"
                                       id="momo"
                                       value="MOMO">
                                <label class="form-check-label" for="momo">
                                    <strong>Ví MoMo</strong>
                                    <p class="text-muted small mb-0">Thanh toán qua ví điện tử MoMo</p>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="col-lg-5">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Đơn hàng (<span th:text="${cartItems.size()}">0</span> sản phẩm)</h5>
                        </div>
                        <div class="card-body">
                            <!-- Cart Items -->
                            <div class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="d-flex mb-3 pb-3 border-bottom" th:each="item : ${cartItems}">

                                    <!-- *** PHẦN HIỂN THỊ ẢNH ĐÃ ĐƯỢC CẬP NHẬT *** -->
                                    <th:block th:with="book=${item.book}">
                                        <th:block th:if="${book.imageUrl != null and not #strings.isEmpty(book.imageUrl)}">
                                            <th:block th:with="imageSrc=${#strings.startsWith(book.imageUrl, 'http') ? book.imageUrl : '/book-uploads/' + book.imageUrl}">
                                                <img th:src="${imageSrc}"
                                                     th:alt="${book.title}"
                                                     class="rounded me-2"
                                                     style="width: 60px; height: 75px; object-fit: cover;"
                                                     onerror="this.onerror=null; this.src='/images/placeholder.png';">
                                            </th:block>
                                        </th:block>
                                        <th:block th:unless="${book.imageUrl != null and not #strings.isEmpty(book.imageUrl)}">
                                            <img th:src="@{/images/placeholder.png}"
                                                 alt="No image"
                                                 class="rounded me-2"
                                                 style="width: 60px; height: 75px; object-fit: cover;">
                                        </th:block>
                                    </th:block>
                                    <!-- *** KẾT THÚC CẬP NHẬT *** -->

                                    <div class="flex-grow-1">
                                        <h6 class="mb-1" th:text="${item.book.title}">Book Title</h6>
                                        <small class="text-muted">
                                            Số lượng: <span th:text="${item.quantity}">1</span>
                                        </small>
                                        <br>
                                        <small class="text-primary fw-bold">
                                                <span th:text="${#numbers.formatDecimal(item.book.price * item.quantity, 0, 'COMMA', 0, 'POINT')} + 'đ'">
                                                    299,000đ
                                                </span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <!-- Price Summary -->
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tạm tính:</span>
                                <strong th:text="${#numbers.formatDecimal(cartTotal, 0, 'COMMA', 0, 'POINT')} + 'đ'">
                                    598,000đ
                                </strong>
                            </div>

                            <div class="d-flex justify-content-between mb-2">
                                <span>Phí vận chuyển:</span>
                                <span th:if="${shippingFee == 0}">
                                        <del class="text-muted">30,000đ</del>
                                        <strong class="text-success ms-2">Miễn phí</strong>
                                    </span>
                                <strong th:if="${shippingFee > 0}"
                                        th:text="${#numbers.formatDecimal(shippingFee, 0, 'COMMA', 0, 'POINT')} + 'đ'">
                                    30,000đ
                                </strong>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between mb-4">
                                <h5>Tổng cộng:</h5>
                                <h5 class="text-danger"
                                    th:text="${#numbers.formatDecimal(grandTotal, 0, 'COMMA', 0, 'POINT')} + 'đ'">
                                    628,000đ
                                </h5>
                            </div>

                            <!-- Place Order Button -->
                            <button type="submit" class="btn btn-success w-100 btn-lg mb-2">
                                <i class="bi bi-check-circle"></i> Đặt hàng
                            </button>

                            <a href="/cart" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-arrow-left"></i> Quay lại giỏ hàng
                            </a>

                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <i class="bi bi-shield-check"></i>
                                    Thông tin của bạn được bảo mật
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Footer -->
<div th:replace="layout/footer :: footer"></div>

<!-- Scripts -->
<div th:replace="layout/header :: scripts"></div>
</body>
</html>
